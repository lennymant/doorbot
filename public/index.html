<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="UTF-8" />
  <title>Door4 Chatbot</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- üîä Sound for bot reply -->
  <audio id="blipSound" src="sounds/doubletap.mp3" preload="auto"></audio>

  <!-- ‚ö†Ô∏è Test Mode Banner -->
  <div id="testBanner" class="test-banner hidden">
    ‚ö†Ô∏è You are running in <strong>TEST MODE</strong>
  </div>

  <!-- ‚è≥ Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-message">‚è≥ Opening Door4 chat... hold tight...</div>
  </div>

  <!-- üí¨ Chat Area -->
  <div id="chatBox"></div>

  <!-- ‚úçÔ∏è Typing Indicator -->
  <div id="typingIndicator" class="typing-indicator hidden">
    Mac is typing<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
  </div>

  <!-- üîπ Input Area -->
  <div id="inputArea">
    <input id="userInput" type="text" placeholder="Ask something..." />
    <button onclick="send()">Send</button>
  </div>

  <!-- üîÑ Reset Chat Button -->
  <div style="text-align: center; padding: 10px;">
    <button onclick="resetChat()"
      style="background: #eee; color: #333; padding: 8px 16px; border-radius: 6px; border: 1px solid #aaa; cursor: pointer;">
      Reset Chat
    </button>
  </div>

  <!-- ‚ö†Ô∏è Reset Confirmation Modal -->
  <div id="confirmModal" class="modal hidden">
    <div class="modal-content">
      <p>Are you sure you want to reset this chat?</p>
      <button id="confirmYes">Yes, reset</button>
      <button id="confirmNo">Cancel</button>
    </div>
  </div>

  <!-- ========================= -->
  <!-- üöÄ Main Script -->
  <!-- ========================= -->
  <script>
    const TESTING_MODE = true;

    if (TESTING_MODE) {
      document.getElementById("testBanner").classList.remove("hidden");
    }

    const input = document.getElementById("userInput");
    const chat = document.getElementById("chatBox");

    // Handle "Enter to Send"
    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        send();
      }
    });

    // Setup Modal Listeners ONCE
    const modal = document.getElementById("confirmModal");
    document.getElementById("confirmYes").onclick = function() {
      modal.classList.add("hidden");
      localStorage.removeItem("threadId");
      localStorage.removeItem("chatHistory");
      chat.innerHTML = '';
      document.getElementById("loadingOverlay").classList.remove("hidden");
      send("[[BEGIN-CHAT]]");
    };
    document.getElementById("confirmNo").onclick = function() {
      modal.classList.add("hidden");
    };

    // Load Previous Chat if Exists
    const savedThreadId = localStorage.getItem("threadId");
    const savedMessages = JSON.parse(localStorage.getItem("chatHistory") || "[]");

    // Only load saved messages if we have a thread ID
    if (savedThreadId && savedMessages.length > 0) {
      savedMessages.forEach(({ role, text }) => addMessage(role, text));
    } else {
      // Clear any stale data and start fresh
      localStorage.removeItem("threadId");
      localStorage.removeItem("chatHistory");
      document.getElementById("loadingOverlay").classList.remove("hidden");
      setTimeout(() => send("[[BEGIN-CHAT]]"), 100);
    }

    // Renderer for Markdown Links
    const renderer = new marked.Renderer();
    renderer.link = function (href, title, text) {
      return `<a href="${href}" target="_blank" rel="noopener noreferrer">${text}</a>`;
    };
    marked.setOptions({ renderer });

    // ---------------------------
    // Functions
    // ---------------------------

    async function send(msgOverride = null) {
      const message = msgOverride || input.value.trim();
      if (!message) return;

      const isHiddenUserCommand = /^\[\[.*\]\]$/.test(message);

      if (!msgOverride && !isHiddenUserCommand) {
        addMessage("user", message);
        input.value = "";
      }

      const threadId = localStorage.getItem("threadId");

      try {
        showTyping();

        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, threadId })
        });

        const data = await res.json();
        hideTyping();

        if (data.reply) {
          document.getElementById("loadingOverlay").classList.add("hidden");
          addMessage("bot", data.reply);
          if (data.threadId) {
            localStorage.setItem("threadId", data.threadId);
          }
          const history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
          history.push({ role: "user", text: message });
          history.push({ role: "bot", text: data.reply });
          localStorage.setItem("chatHistory", JSON.stringify(history));
        } else {
          addMessage("bot", "Sorry, something went wrong.");
        }
      } catch (err) {
        hideTyping();
        console.error("Error sending message:", err);
        addMessage("bot", "Sorry, there was a problem connecting.");
      }

      input.focus();
    }

    function addMessage(role, text) {
      const container = document.createElement("div");
      const isHidden = /^\[\[.*\]\]$/.test(text.trim());
      const matches = [...text.matchAll(/\{\{(.*?)\}\}/g)];

      const cleanedText = text
        .replace(/\[\[.*?\]\]/g, '')
        .replace(/^\s*[-*]?\s*\{\{.*?\}\}\s*$/gm, '')
        .replace(/\{\{.*?\}\}/g, '')
        .replace(TESTING_MODE ? '' : /„Äê[^„Äê„Äë]*‚Ä†[^„Äê„Äë]*‚Ä†[^„Äê„Äë]*„Äë/g, '')
        .replace(/\n{3,}/g, '\n\n')
        .trim();

      if (isHidden || !cleanedText) return;

      const div = document.createElement("div");
      div.className = `message ${role}`;
      div.innerHTML = marked.parse(cleanedText);
      container.appendChild(div);

      if (role === "bot" && !isHidden) {
        const blip = document.getElementById("blipSound");
        blip.currentTime = 0;
        blip.play();
      }

      if (role === "bot" && matches.length > 0) {
        const buttonRow = document.createElement("div");
        buttonRow.className = "bot-option-container";

        matches.forEach(match => {
          const btnText = match[1];
          const btn = document.createElement("button");
          btn.innerText = btnText;
          btn.className = "bot-option";
          btn.onclick = () => {
            addMessage("user", btnText);
            send(btnText);
            buttonRow.remove();
          };
          buttonRow.appendChild(btn);
        });

        container.appendChild(buttonRow);
      }

      chat.appendChild(container);
      chat.scrollTop = chat.scrollHeight;
      input.focus();
    }

    function resetChat() {
      modal.classList.remove("hidden");
    }

    function showTyping() {
      document.getElementById("typingIndicator").classList.remove("hidden");
      document.getElementById("typingIndicator").classList.add("visible");
      chat.classList.add("typing-active");
    }

    function hideTyping() {
      document.getElementById("typingIndicator").classList.remove("visible");
      document.getElementById("typingIndicator").classList.add("hidden");
      chat.classList.remove("typing-active");
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>

</html>
