<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta charset="UTF-8" />
  <title>Door4 Chatbot</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <audio id="blipSound" src="sounds/doubletap.mp3" preload="auto"></audio>

  <div id="testBanner" class="test-banner hidden">
    ‚ö†Ô∏è You are running in <strong>TEST MODE</strong>
  </div>

  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-message">‚è≥ Opening Door4 chat... hold tight...</div>
  </div>


  <div id="chatBox"></div>
  <div id="typingIndicator" class="typing-indicator hidden">
    Mac is typing<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
  </div>

  <div id="inputArea">
    <input id="userInput" type="text" placeholder="Ask something..." />
    <button onclick="send()">Send</button>
  </div>

  <div style="text-align: center; padding: 10px;">
    <button onclick="resetChat()"
      style="background: #eee; color: #333; padding: 8px 16px; border-radius: 6px; border: 1px solid #aaa; cursor: pointer;">
      Reset Chat
    </button>
  </div>

  <script>
    const TESTING_MODE = true;
    if (TESTING_MODE) {
      document.getElementById("testBanner").classList.remove("hidden");
    }

    const input = document.getElementById("userInput");
    const chat = document.getElementById("chatBox");

    const savedThreadId = localStorage.getItem("threadId");
    const savedMessages = JSON.parse(localStorage.getItem("chatHistory") || "[]");

    savedMessages.forEach(({ role, text }) => addMessage(role, text));

    if (!savedThreadId && savedMessages.length === 0) {
      document.getElementById("loadingOverlay").classList.remove("hidden");

      setTimeout(() => send("[[BEGIN-CHAT]]"), 100);
    }

    document.addEventListener("DOMContentLoaded", function () {
      const input = document.getElementById("userInput");

      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          send();
        }
      });
    });

    async function send(msgOverride = null) {
      const message = msgOverride || input.value.trim();
      if (!message) return;

      const isHiddenUserCommand = /^\[\[.*\]\]$/.test(message);

      if (!msgOverride && !isHiddenUserCommand) {
        addMessage("user", message);
        input.value = "";
      }

      const threadId = localStorage.getItem("threadId");

      try {
        showTyping();

        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, threadId })
        });

        const data = await res.json();
        hideTyping();

        if (data.reply) {
          document.getElementById("loadingOverlay").classList.add("hidden");
          addMessage("bot", data.reply);
          if (data.threadId) {
            localStorage.setItem("threadId", data.threadId);
          }
          const history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
          history.push({ role: "user", text: message });
          history.push({ role: "bot", text: data.reply });
          localStorage.setItem("chatHistory", JSON.stringify(history));
        } else {
          addMessage("bot", "Sorry, something went wrong.");
        }
      } catch (err) {
        hideTyping();
        console.error("Error sending message:", err);
        addMessage("bot", "Sorry, there was a problem connecting.");
      }

      input.focus();
    }


    const renderer = new marked.Renderer();

renderer.link = function (href, title, text) {
  return `<a href="${href}" target="_blank" rel="noopener noreferrer">${text}</a>`;
};

marked.setOptions({ renderer });



    function addMessage(role, text) {
      const container = document.createElement("div");
      const isHidden = /^\[\[.*\]\]$/.test(text.trim());
      const matches = [...text.matchAll(/\{\{(.*?)\}\}/g)];

      const cleanedText = text
        // Remove hidden system commands like [[BEGIN-CHAT]]
        .replace(/\[\[.*?\]\]/g, '')

        // Remove lines that ONLY contain button placeholders
        .replace(/^\s*[-*]?\s*\{\{.*?\}\}\s*$/gm, '')

        // Remove any inline {{button}} placeholders
        .replace(/\{\{.*?\}\}/g, '')

        // Remove citations if not in testing mode
        .replace(TESTING_MODE ? '' : /„Äê[^„Äê„Äë]*‚Ä†[^„Äê„Äë]*‚Ä†[^„Äê„Äë]*„Äë/g, '')

        // Collapse excessive blank lines
        .replace(/\n{3,}/g, '\n\n')

        .trim();

      if (isHidden || !cleanedText) return;

      const div = document.createElement("div");
      div.className = `message ${role}`;

      div.innerHTML = marked.parse(cleanedText);
      container.appendChild(div);

      if (role === "bot" && !isHidden && cleanedText) {
        const blip = document.getElementById("blipSound");
        blip.currentTime = 0;  // rewind to start
        blip.play();
      }

      if (role === "bot" && matches.length > 0) {
        const buttonRow = document.createElement("div");
        buttonRow.className = "bot-option-container";

        matches.forEach(match => {
          const btnText = match[1];
          const btn = document.createElement("button");
          btn.innerText = btnText;
          btn.className = "bot-option";
          btn.onclick = () => {
            addMessage("user", btnText);
            send(btnText);
            buttonRow.remove();
          };
          buttonRow.appendChild(btn);
        });

        container.appendChild(buttonRow);
      }


      chat.appendChild(container);
      chat.scrollTop = chat.scrollHeight;
      input.focus();
    }

    function resetChat() {
      const confirmReset = confirm("Are you sure you want to reset this chat?");
      if (confirmReset) {
        localStorage.removeItem("threadId");
        localStorage.removeItem("chatHistory");
        chat.innerHTML = '';

        // üî• Show the loading overlay again
        document.getElementById("loadingOverlay").classList.remove("hidden");

        // Trigger new chat thread
        send("[[BEGIN-CHAT]]");
      }
    }

    function showTyping() {
      document.getElementById("typingIndicator").classList.remove("hidden");
      document.getElementById("typingIndicator").classList.add("visible");
      document.getElementById("chatBox").classList.add("typing-active");
    }

    function hideTyping() {
      document.getElementById("typingIndicator").classList.remove("visible");
      document.getElementById("typingIndicator").classList.add("hidden");
      document.getElementById("chatBox").classList.remove("typing-active");
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</body>

</html>