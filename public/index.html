<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="UTF-8" />
  <title>Door4 Chatbot</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- üîä Sound for bot reply -->
  <audio id="blipSound" src="sounds/doubletap.mp3" preload="auto"></audio>

  <!-- ‚ö†Ô∏è Test Mode Banner -->
  <div id="testBanner" class="test-banner hidden">
    ‚ö†Ô∏è You are running in <strong>TEST MODE</strong>
  </div>

  <!-- ‚è≥ Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-message">
      <div class="loading-circle"></div>
      <div class="loading-text">Opening Door4 chat... hold tight...</div>
    </div>
  </div>

  <!-- üí¨ Chat Area -->
  <div id="chatBox"></div>

  <!-- ‚úçÔ∏è Typing Indicator -->
  <div id="typingIndicator" class="typing-indicator hidden">
    <div class="typing-bubble">
      <div class="typing-avatar">M</div>
      <div class="typing-content">
        <div class="typing-name">Door4 Assistant</div>
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- üîπ Input Area -->
  <div id="inputArea">
    <input id="userInput" type="text" placeholder="Type your message here..." />
    <button onclick="handleSend()">Send</button>
  </div>

  <!-- üîÑ Reset Chat Button -->
  <div class="reset-button-container">
    <button onclick="resetChat()" class="reset-button">
      Reset Chat
    </button>
    <div class="timestamp"></div>
  </div>

  <!-- ‚ö†Ô∏è Reset Confirmation Modal -->
  <div id="confirmModal" class="modal hidden">
    <div class="modal-content">
      <p>Are you sure you want to reset this chat?</p>
      <button id="confirmYes">Yes, reset</button>
      <button id="confirmNo">Cancel</button>
    </div>
  </div>

  <!-- ========================= -->
  <!-- üöÄ Main Script -->
  <!-- ========================= -->
  <script>
    const TESTING_MODE = false;

    if (TESTING_MODE) {
      const testBanner = document.getElementById("testBanner");
      testBanner.classList.remove("hidden");
      
      // Check if running locally
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      if (isLocalhost) {
        testBanner.innerHTML += ' <strong>RUNNING LOCALLY</strong>';
      }
    }

    // Get bot type from URL query string
    const urlParams = new URLSearchParams(window.location.search);
    const botType = urlParams.get('bot');

    const chat = document.getElementById("chatBox");
    let chatStartTime = null;

    // Function to handle sending messages
    function handleSend(e) {
      if (e) e.preventDefault();
      const inputElement = document.getElementById("userInput");
      if (!inputElement) return;
      
      const message = inputElement.value.trim();
      if (!message) return;

      // Remove any existing option bubbles
      const optionContainers = document.querySelectorAll('.bot-option-container');
      optionContainers.forEach(container => container.remove());

      addMessage("user", message);
      inputElement.value = "";
      sendMessage(message);
    }

    // Function to send message to server
    async function sendMessage(message) {
      const threadId = localStorage.getItem("threadId");
      console.log("Current thread ID:", threadId);

      try {
        showTyping();

        // Only add time to BEGIN-CHAT message
        let messageToSend = message;
        if (message.includes("[[BEGIN-CHAT]]")) {
          const ukTime = new Date().toLocaleString("en-GB", {
            timeZone: "Europe/London",
            weekday: "short",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false
          });
          messageToSend = `${message} [[TIME:${ukTime}]]`;
        }

        // Add bot type to request
        const requestBody = {
          message: messageToSend,
          threadId,
          chatDuration: chatStartTime ? Math.floor((Date.now() - chatStartTime) / 1000) : 0,
          botType: botType // Always send bot type
        };

        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestBody)
        });

        const data = await res.json();
        console.log("Received response:", data);
        hideTyping();

        if (data.reply) {
          document.getElementById("loadingOverlay").classList.add("hidden");
          addMessage("bot", data.reply, data.assistantId);
          if (data.threadId) {
            localStorage.setItem("threadId", data.threadId);
            console.log("New thread ID saved:", data.threadId);
          }
          const history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
          history.push({ role: "user", text: message });
          history.push({ role: "bot", text: data.reply });
          localStorage.setItem("chatHistory", JSON.stringify(history));
        } else {
          console.error("No reply in response:", data);
          addMessage("bot", "Sorry, something went wrong.");
        }
      } catch (err) {
        hideTyping();
        console.error("Error sending message:", err);
        addMessage("bot", "Sorry, there was a problem connecting.");
      }

      document.getElementById("userInput")?.focus();
    }

    // Setup Modal Listeners ONCE
    const modal = document.getElementById("confirmModal");
    document.getElementById("confirmYes").onclick = function() {
      modal.classList.add("hidden");
      localStorage.removeItem("threadId");
      localStorage.removeItem("chatHistory");
      chat.innerHTML = '';
      
      // Restore input area to original state
      const inputArea = document.getElementById("inputArea");
      inputArea.innerHTML = `
        <input id="userInput" type="text" placeholder="Ask something..." />
        <button onclick="handleSend()">Send</button>
      `;
      inputArea.classList.remove("chat-ended");
      
      // Reattach event listeners
      const newInput = document.getElementById("userInput");
      if (newInput) {
        newInput.addEventListener("keydown", function(e) {
          if (e.key === "Enter") handleSend(e);
        });
      }
      
      // Reset chat timer
      chatStartTime = Date.now();
      
      // Get current UK time
      const ukTime = new Date().toLocaleString("en-GB", {
        timeZone: "Europe/London",
        weekday: "short",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
      
      document.getElementById("loadingOverlay").classList.remove("hidden");
      // Add bot type to BEGIN-CHAT message
      const botParam = botType ? ` [[BOT:${botType}]]` : '';
      sendMessage(`[[BEGIN-CHAT]]${botParam} [[TIME:${ukTime}]]`);
    };
    document.getElementById("confirmNo").onclick = function() {
      modal.classList.add("hidden");
    };

    // Initialize chat when DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log("DOM fully loaded, initializing chat...");
      
      // Setup initial event listeners
      const inputElement = document.getElementById("userInput");
      if (inputElement) {
        inputElement.addEventListener("keydown", function(e) {
          if (e.key === "Enter") handleSend(e);
        });
      }

      // Update timestamp
      function updateTimestamp() {
        const ukTime = new Date().toLocaleString("en-GB", {
          timeZone: "Europe/London",
          weekday: "short",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        });
        document.querySelector('.timestamp').textContent = ukTime;
      }
      
      // Update timestamp immediately and every minute
      updateTimestamp();
      setInterval(updateTimestamp, 60000);
      
      // Load Previous Chat if Exists
      const savedThreadId = localStorage.getItem("threadId");
      const savedMessages = JSON.parse(localStorage.getItem("chatHistory") || "[]");

      console.log("Initial load - Thread ID:", savedThreadId);
      console.log("Initial load - Saved messages:", savedMessages);

      // Only load saved messages if we have a thread ID
      if (savedThreadId && savedMessages.length > 0) {
        console.log("Loading existing chat...");
        savedMessages.forEach(({ role, text }) => addMessage(role, text));
      } else {
        console.log("Starting new chat...");
        // Clear any stale data and start fresh
        localStorage.removeItem("threadId");
        localStorage.removeItem("chatHistory");
        document.getElementById("loadingOverlay").classList.remove("hidden");
        
        // Get current UK time
        const ukTime = new Date().toLocaleString("en-GB", {
          timeZone: "Europe/London",
          weekday: "short",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        });
        
        console.log("Sending time to chatbot:", ukTime);
        
        // Start the chat timer
        chatStartTime = Date.now();
        
        // Send initial message with time info and bot type
        const botParam = botType ? ` [[BOT:${botType}]]` : '';
        sendMessage(`[[BEGIN-CHAT]]${botParam} [[TIME:${ukTime}]]`);
      }
    });

    // Make handleSend available globally
    window.handleSend = handleSend;

    // Renderer for Markdown Links
    const renderer = new marked.Renderer();
    renderer.link = function (href, title, text) {
      return `<a href="${href}" target="_blank" rel="noopener noreferrer">${text}</a>`;
    };
    marked.setOptions({ renderer });

    // ---------------------------
    // Functions
    // ---------------------------

    function addMessage(role, text) {
      const container = document.createElement("div");
      const isHidden = /^\[\[.*\]\]$/.test(text.trim());
      const matches = [...text.matchAll(/\{\{(.*?)\}\}/g)];

      const cleanedText = text
        .replace(/\[\[.*?\]\]/g, '')
        .replace(/^\s*[-*]?\s*\{\{.*?\}\}\s*$/gm, '')
        .replace(/\{\{.*?\}\}/g, '')
        .replace(TESTING_MODE ? '' : /„Äê[^„Äê„Äë]*‚Ä†[^„Äê„Äë]*‚Ä†[^„Äê„Äë]*„Äë/g, '')
        .replace(/\n{3,}/g, '\n\n')
        .trim();

      if (isHidden || !cleanedText) return;

      const div = document.createElement("div");
      div.className = `message ${role}`;
      div.innerHTML = marked.parse(cleanedText);
      container.appendChild(div);

      if (role === "bot" && !isHidden) {
        const blip = document.getElementById("blipSound");
        blip.currentTime = 0;
        blip.play();
      }

      if (role === "bot" && matches.length > 0) {
        const buttonRow = document.createElement("div");
        buttonRow.className = "bot-option-container";

        // Add instructional text
        const instructionText = document.createElement("div");
        instructionText.className = "option-instruction";
        instructionText.textContent = "You can click a button below or type your own message:";
        buttonRow.appendChild(instructionText);

        matches.forEach(match => {
          const btnText = match[1];
          const btn = document.createElement("button");
          btn.innerText = btnText;
          btn.className = "bot-option";
          btn.onclick = () => {
            addMessage("user", btnText);
            sendMessage(btnText);
            buttonRow.remove();
          };
          buttonRow.appendChild(btn);
        });

        container.appendChild(buttonRow);
      }

      chat.appendChild(container);
      chat.scrollTop = chat.scrollHeight;
      document.getElementById("userInput")?.focus();

      // Check for END-CHAT command after displaying the message
      if (text.toUpperCase().includes('[[END-CHAT]]')) {
        const inputArea = document.getElementById("inputArea");
        inputArea.innerHTML = `
          <div class="chat-ended-message">
            <div class="chat-ended-icon">‚úì</div>
            <div class="chat-ended-text">The Chat has ended</div>
          </div>
        `;
        inputArea.classList.add("chat-ended");
      }
    }

    function resetChat() {
      modal.classList.remove("hidden");
    }

    function showTyping() {
      document.getElementById("typingIndicator").classList.remove("hidden");
      document.getElementById("typingIndicator").classList.add("visible");
      chat.classList.add("typing-active");
    }

    function hideTyping() {
      document.getElementById("typingIndicator").classList.remove("visible");
      document.getElementById("typingIndicator").classList.add("hidden");
      chat.classList.remove("typing-active");
    }

    // Add function to show input area
    function showInputArea() {
      document.getElementById("inputArea").classList.remove("hidden");
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>

</html>
